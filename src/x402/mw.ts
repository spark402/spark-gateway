import type {Request,Response,NextFunction} from 'express';import {buildQuote} from './quote.js';import axios from 'axios';const VER=process.env.VERIFIER_URL||'http://localhost:8788';export async function x402Guard(req:Request,res:Response,next:NextFunction){const x=req.header('X-PAYMENT');if(!x){return res.status(402).json(buildQuote({resource:req.path}))}let ref=null;try{ref=JSON.parse(Buffer.from(x,'base64').toString()).ref}catch{}if(!ref)return res.status(400).json({error:'malformed'});try{const r=await axios.get(`${VER}/verify?ref=${encodeURIComponent(ref)}`);if(r.data?.ok)return next();if(r.status===409)return res.status(409).json({error:'pending'});return res.status(401).json({error:'not_verified'});}catch(e){return res.status(502).json({error:'verifier_down'})}}
